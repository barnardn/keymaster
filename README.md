
# Keymaster

A web service application that manages app keys for iOS applications (or other applicable use cases). Input to the service is a set of
credentials, the output is a blob of json that contains the set of credentials in an encrypted and serialized format. The intent is that on
first launch of the app, the contents of the file are decrypted and imported into the app's keychain. When a set of credentials are retrieved from `keymaster`, the output is as follows in the exmaple below:

	{
		"cypherKey":"eb5108f4-d01f-472b-755a-2f407ac732b3",
		"cypherText":"tif4x89NOGLvHMqEPHMXi7Bxy/mFgPuIQ32SCrYv/RXyZAeBihtUTsF4s7TLolx3q6XKFuTqqrVB2bdmnB0p73Jo8Ui
					  JpYsZ8E3CCRagxmWPZEYthVwlaRbC5Pja/dpMTpb9SYIBmW8HYjlx6AhPFFGaWoo3D2zfOEJ2++C5V7RJfeVQg7Pg0z
					  Wxv20NqgYk6WxqkRD9y0ffYotwgaoLJTuXUUG7z0cC5b8iFXuLIjPeuxLh4tSBOOixuiM+aII4Z4DsND0OOEfNXzNvI
					  eDEvpC+b7aj0KtjXJCCaHA+iDP/05oET34DzYm8TORysFWzwPruG+YW1sbO4NRMqeGNIg=="
	}

The `cypherKey` is the acutal key used to encrypt the credentials. Encryption method is AES encryption using a 16bit UUID as the key and initialization vector. The returned `cypherText` is a base64 encoded representation of the encrypted credentials. It's expected that this output be written to a file and included in your app's distribution bundle and loaded into your app's keychain on first time startup.

#### Important Note

`keymaster` is *NOT* intended to be a highly secure password vault. It's primary purpose is to keep the credentials used by your app 
outside of your apps source code repository but easily reference in a common location. Although the output generated by `keymaster` is encrypted, it's also recommended that upon first run of your app, you import they `keymaster` credentials output into your app secure keychain facility. If you can then delete the `keymaster` output, then do so. If you can't (say it's in yoru iOS bundle), then for an added measure of security, albeit probably not ultra-secure, remove the `cypherKey` from the credentials JSON file and store it separately in your app - preferably not as a string, but the 16 bytes which make up the UUID.

## Gatekeeper

Included is a command line utility, `gatekeeper` which clients can use to communicate with `keymaster`. It's expected that `gatekeeper` is to be used somewhere in the build process of your app to extract the keys required for your apps installation bundle. Usage is as follows:

	$ gatekeeper -cmd [add|update|list|get|reissue] [-appid application-id] [-keymaster url-to-server] [-output output-path] [-spec input-credentials.json] [-decrypt]

	where: 
	
	-appid="": The application identifer of the credentials you wish to operate on
	-cmd="list": Where command is one of [add update list get reissue]
	-decrypt=false: Decrypt the contents of the retrieved credentials to stdout
	-keymaster="": Full of keymaster server. overrides KEYMASTER_SERVER_URL environment variable if set
	-output="": Output file in which to store credentials. omit for stdout
	-spec="": The application credentials spec file [json]

The input spec file format must be JSON and have the following structure: 

	{
	    "appNames" : [ 
	        { "AppName" : "idenfifier.of.your.app"},...
	    ],
	    "keys" : [
		{ 
		    "name" : "credentials-name",
		    "info" : "some method of representing your credentials"
		}, ...
	    ]
	}

The `appNames` key defines an array of all the various app names your particular app may use during it's development lifecyle (for instance, you use `com.clamdango.codename`, but `com.clamdango.myapp` when you submit for production).

The `keys` refer to an array of named credential definitions. Each definition must consist of a `name` and `info`. The `info` key is were you are to list out your actual credentials. Typical use case is that the `info` key will consist of a string of JSON that is decoded within your app and imported into your app's secure keychanin.  An example credentials spec is provided below:

	{
	    "appNames" : [ 
	        { "AppName" : "com.clamdango.appone"},
	        { "AppName" : "com.clamdango.apptwo"},
	        { "AppName" : "com.clamdango.appthree"}
	    ],
	    "keys" : [
		{ 
		    "name" : "production",
		    "info" : "{ \"api\" : \"some-production-api-key--xx\",\"username\" : \"random_username\",\"password\" : \"random_password\"}"
		}, 
		{ 
		    "name" : "development",
		    "info" : "{\"api\" : \"some-development-api-key-xxx\",\"username\" : \"dev_username\",\"password\" : \"dev_password\"}"
		}
	    ]
	}



## HTTP Web Service:

All error conditions will contain a JSON response body with any error details. The only exception may be in the case of internal server errors, where a response body could not be created.

HTTP status code 400 is returned as the result of any malformed client requests. More specific status codes are returned for more
specific error conditions.

### Error Reponse

	{
		"Message" : "an error message string"
	}

		
## Credentials

### Creating Credentials Set

/api/credentials

POST: creates a new credential bundle. returns the encrypted bundle and the AES encryption key in the response.

ex:

	REQUEST: POST /api/credentials

    {
	"appNames" : [ { "AppName" : "com.clamdango.primary"}, {"AppName" : "com.clamdango.secondary"}, {"AppName" : "com.maestromobile.alias"} ],
	"keys" : [
	    { 
		"name" : "production",
		"info" : "{ \"api\" : \"some-production-api-key\",\"username\" : \"random_username\",\"password\" : \"random_password\"}"
	    }, 
	    { 
		"name" : "staging",
		"info" : "{\"api\" : \"some-staging-api-key\",\"username\" : \"staging_username\",\"password\" : \"staging_password\"}"
	    }, 
	    { 
		"name" : "development",
		"info" : "{\"api\" : \"some-development-api-key\",\"username\" : \"dev_username\",\"password\" : \"dev_password\"}"
	    }
	]
	}

		
RESPONSE:
201: CREATED
	
	{
		"cipher_key" : "abc-def-ghi-jklmnop",
		"cipher_text" : {
			"production" : {
				"api" : "an api key", 
				"password" : "a password"
				"username" : "a usernamne"
			}, 
			"development" : {
				"api" : "another api key",
				"username" : "another username",
				"password" : "another password"			
			}
		}
	}

409: Conflict

App bundle identifier exists or exists as an alias of another set of app credentials.

### Notes

The "cipher_text" key contains an encrypted json string which decodes into a json object suitable for deseralizing and importing into an ios keychain.

## Retrieving Credentials

### Retrieving Credentials for an App

REQUEST

	GET /api/credentials/com.maestromobile.appname

RESPONSE:

200: OK

	{
		"cipherKey" : "abc-def-ghi-jklmnop",
		"cipherText" : {
			"production" : {
				"api" : "an api key", 
				"password" : "a password"
				"username" : "a usernamne"
			}, 
			"development" : {
				"api" : "another api key",
				"username" : "another username",
				"password" : "another password"			
			}
		}
	}

#### Notes

The "cipher_text" key contains an encrypted json string which decodes into a json object suitable for deseralizing and importing into an ios keychain.

##### Example

	{
		"cypherKey":"eb5108f4-d01f-472b-755a-2f407ac732b3",
		"cypherText":"tif4x89NOGLvHMqEPHMXi7Bxy/mFgPuIQ32SCrYv/RXyZAeBihtUTsF4s7TLolx3q6XKFuTqqrVB2bdmnB0p73Jo8UiJpYsZ8E3CCRagxmWPZEYthVwlaRbC5Pja/dpMTpb9SYIBmW8HYjlx6AhPFFGaWoo3D2zfOEJ2++C5V7RJfeVQg7Pg0zWxv20NqgYk6WxqkRD9y0ffYotwgaoLJTuXUUG7z0cC5b8iFXuLIjPeuxLh4tSBOOixuiM+aII4Z4DsND0OOEfNXzNvIeDEvpC+b7aj0KtjCaHA+iDP/05oET34DzYm8TORysFWzwPruG+YW1sbO4NRMqeGNIg=="
	}

### Retrieving a List of Application Identifiers

REQUEST	
	
	GET /api/apps
	
RESPONSE	

	[
		["com.clamdango.primary",
		"com.clamdango.secondary",
		"com.maestromobile.alias"],
		
		["com.clamdango.stuff"],

		["com.clamdango.appone",
		"com.clamdango.appthree",
		"com.clamdango.apptwo"]
	]

#### NOTES

The response is an array of array of strings, which represent all the app id's associated to a given set of credentials. Any app id within an inner array will return the same set of credentials as the others in the same array.

## Reissuing a new cypher key

REQUEST:
	
	PATCH:  /api/credentials/com.maestromobile.appname/reissue
	
RESPONSE:
	
200: OK

The response body is the same as with retrieval, however, the "cypher_text" value is encrypted with the new cypher key.

404 : Not Found

The app id provided could not be found.

## Updating Credentials.

A credentials record can be updated. It's expected that the body contains an entirely new representation of the credentials. This new representation will completely replace the existing representation. It makes no attempt to merge entries in the new representation with the previous.

REQUEST:

	PUT: /api/credentials/com.maestromobile.appname
	
RESPONSE:

200: OK
	
	{
		"cipherKey" : "abc-def-ghi-jklmnop",
		"cipherText" : {
			"production" : {
				"api" : "a different key", 
				"password" : "a password"
				"username" : "a usernamne"
			}, 
			"development" : {
				"api" : "another different api key",
				"username" : "another username",
				"password" : "another password"			
			}
		}
	}	
	
404: Not Found

The app id provided could not be found.


